---
import { getLocale } from 'astro-i18n-aut';
import generalDataGetter from '../content/general';
import Form from '../components/Form/Form';
import Link from '../components/Link/Link';
import formEvents from '../components/Form/Form.events';

const locale = getLocale(Astro.url);

const generalData = generalDataGetter(locale);

---
<Form
  client:load
  {...generalData.contactFormData}
>

  <div slot="privacyNote">
    <p>{generalData.contactFormData.privacyNote.preLink} <Link href="#">{generalData.contactFormData.privacyNote.link}</Link> {generalData.contactFormData.privacyNote.postLink}</p>
  </div>

</Form>

<script define:vars={{
  formEvents,
  generalData,
}}>

  /* eslint-disable no-undef */
  window.addEventListener(formEvents.submitForm, async (evt) => {
    const {
      email,
      name,
      text,
    } = evt.detail;

    const message = `
    Contact form on vorhall.com filled out.<br><br>
    from: ${name}, ${email}<br><br>

    message:
    ${text}
    `;

    const url = '/.netlify/functions/send-mail';

    const data = {
      from: 'Vorhall.com Contact <vorhall@resend.dev>',
      message,
      subject: 'Contact form on vorhall.com',
      to: 'vorhall23@gmail.com',
    };

    const options = {
      body: JSON.stringify(data),
      cache: 'no-cache',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
      },
      method: 'POST',
    };

    try {
      const response = await fetch(url, options);
      const responseData = await response.text();
      const responseDataParsed = JSON.parse(responseData);

      if (responseDataParsed.statusCode !== 200) {
        console.log('There was an error sending the mail');
        console.log(responseDataParsed);

        return;
      }

      const dispatchEvent = new CustomEvent(
        formEvents.submitSuccess,
        {
          detail: generalData.contactFormData.submitSuccess,
        },
      );

      window.dispatchEvent(dispatchEvent);

    } catch (e) {
      console.log(e);

      const dispatchEvent = new CustomEvent(
        formEvents.submitError,
        {
          detail: generalData.contactFormData.submitError,
        },
      );

      window.dispatchEvent(dispatchEvent);
    }
    /* eslint-enable no-undef */

  });

</script>
